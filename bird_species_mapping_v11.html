<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bird Species Mapping App v11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
  background: #1e1e1e;
  color: #f0f0f0;
}

#controls {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #2b2b2b;
  padding: 12px;
  z-index: 2000;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
  color: #fff;
}

.overlay-toggle {
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 1000;
  background: #2b2b2b;
  color: #fff;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
  padding: 8px 10px;
  cursor: pointer;
}

.marker-label {
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  background-color: rgba(70, 130, 180, 0.9);
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
}

.target-label {
  font-size: 11px;
  font-weight: bold;
  color: #000;
  background-color: rgba(255, 255, 255, 0.6);
  padding: 4px 6px;
  border-radius: 10px;
  white-space: nowrap;
}

.popup-content {
  font-size: 14px;
  color: #fff;
}

.popup-content button {
  font-size: 14px;
  margin: 4px 2px;
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  background-color: #3a3a3a;
  color: #fff;
  cursor: pointer;
}

.popup-content button:hover {
  background-color: #555;
}

#modalBackdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 1500;
}

#speciesModal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #2c2c2c;
  color: #fff;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 20px;
  z-index: 2001;
  display: none;
  width: 300px;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
}

#speciesModal input[type="text"] {
  background: #1e1e1e;
  border: 1px solid #555;
  color: #fff;
  padding: 6px;
  width: 100%;
  margin-bottom: 10px;
  border-radius: 4px;
}

#speciesList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#speciesList li {
  padding: 6px;
  cursor: pointer;
  border-radius: 4px;
  background: #333;
  margin-bottom: 4px;
}

#speciesList li:hover {
  background: #444;
}

#dataDrawer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 50%;
  background: #2b2b2b;
  border-top: 2px solid #555;
  display: none;
  padding: 12px;
  overflow-y: auto;
  z-index: 2001;
  color: #fff;
}

#dataDrawer h3 {
  margin-top: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#dataDrawer table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

#dataDrawer th, #dataDrawer td {
  border: 1px solid #555;
  padding: 6px;
  text-align: left;
}

#dataDrawer th {
  background: #3a3a3a;
}

#dataDrawer button {
  background: #444;
  color: #fff;
  border: none;
  padding: 5px 10px;
  margin: 4px 2px;
  border-radius: 4px;
  cursor: pointer;
}

#dataDrawer button:hover {
  background: #555;
}

.open-drawer-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 2000;
  background: #2b2b2b;
  color: #fff;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

input[type="text"] {
  background: #1e1e1e;
  border: 1px solid #555;
  color: #fff;
  padding: 6px;
  border-radius: 4px;
}
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div id="controls">
  <label>Survey Point ID:</label>
  <input type="text" id="pointID" /><br>
  <label>Observer:</label>
  <input type="text" id="observer" />
</div>
<div class="open-drawer-btn" onclick="openDrawer()">ðŸ“‹ Data</div>
<div id="map"></div>
<div class="overlay-toggle" title="Toggle Overlay" onclick="toggleOverlay()">ðŸŽ¯</div>

<div id="modalBackdrop" onclick="closeModal()"></div>

<!-- Species Modal -->
<div id="speciesModal">
  <h3>Select Bird</h3>
  <input type="text" id="speciesSearch" placeholder="Search species..." />
  <ul id="speciesList" style="max-height: 200px; overflow: auto;"></ul>
</div>

<!-- Data Drawer -->
<div id="dataDrawer">
  <h3>
    Species Records
    <button onclick="closeDrawer()">âœ–</button>
  </h3>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="exportGeoJSON()">Export GeoJSON</button>
  <table>
    <thead>
      <tr><th>POINT_ID</th><th>OBSERVER</th><th>SPECIES</th><th>SP_Count</th><th>RANGE (m)</th><th>BEARING (Â°)</th><th>OBS_TIMESTAMP</th></tr>
    </thead>
    <tbody id="dataTableBody"></tbody>
  </table>
</div>

<script>
const map = L.map('map');
let observerLocation = null;
const speciesData = ["AMRO", "AMKE", "BAEA", "BLJA", "BARS"];
const speciesMarkers = [];
let placingPoint = false;
let currentLatLng = null;

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
L.control.layers({ "OSM": osm, "Satellite": satellite }).addTo(map);

navigator.geolocation.getCurrentPosition(pos => {
  const coords = [pos.coords.latitude, pos.coords.longitude];
  map.setView(coords, 17);
  observerLocation = L.latLng(coords);
});

function destinationPoint(latlng, bearing, distance) {
  const R = 6378137, Î´ = distance / R, Î¸ = bearing * Math.PI / 180;
  const Ï†1 = latlng.lat * Math.PI / 180, Î»1 = latlng.lng * Math.PI / 180;
  const Ï†2 = Math.asin(Math.sin(Ï†1) * Math.cos(Î´) + Math.cos(Ï†1) * Math.sin(Î´) * Math.cos(Î¸));
  const Î»2 = Î»1 + Math.atan2(Math.sin(Î¸) * Math.sin(Î´) * Math.cos(Ï†1),
                             Math.cos(Î´) - Math.sin(Ï†1) * Math.sin(Ï†2));
  return L.latLng(Ï†2 * 180 / Math.PI, Î»2 * 180 / Math.PI);
}

let overlayGroup;
function toggleOverlay() {
  if (overlayGroup) {
    map.removeLayer(overlayGroup);
    overlayGroup = null;
  } else if (observerLocation) {
    const center = observerLocation;
    overlayGroup = L.layerGroup();

    [50, 100, 150].forEach(r => {
      L.circle(center, { radius: r, color: 'red', dashArray: '4', fillOpacity: 0 }).addTo(overlayGroup);
    });

    [0, 45, 90, 135, 180, 225, 270, 315].forEach(angle => {
      const end = destinationPoint(center, angle, 150);
      L.polyline([center, end], { color: 'red', weight: 1 }).addTo(overlayGroup);
    });

    const dirs = { N: 0, E: 90, S: 180, W: 270 };
    for (const [txt, angle] of Object.entries(dirs)) {
      const pt = destinationPoint(center, angle, 160);
      L.marker(pt, {
        icon: L.divIcon({ className: 'target-label', html: txt })
      }).addTo(overlayGroup);
    }

    overlayGroup.addTo(map);
  }
}

function showSpeciesModal(latlng) {
  if (!document.getElementById('observer').value || !document.getElementById('pointID').value) {
    alert("Please enter Survey Point ID and Observer.");
    return;
  }
  placingPoint = true;
  currentLatLng = latlng;
  document.getElementById('speciesModal').style.display = 'block';
  document.getElementById('modalBackdrop').style.display = 'block';
  updateSpeciesList('');
}

function closeModal() {
  placingPoint = false;
  currentLatLng = null;
  document.getElementById('speciesModal').style.display = 'none';
  document.getElementById('modalBackdrop').style.display = 'none';
}

function updateSpeciesList(filter) {
  const list = document.getElementById('speciesList');
  list.innerHTML = '';
  speciesData.filter(code => code.includes(filter.toUpperCase())).forEach(code => {
    const li = document.createElement('li');
    li.innerText = code;
    li.style.cursor = 'pointer';
    li.onclick = () => placeSpeciesPoint(code);
    list.appendChild(li);
  });
}

function placeSpeciesPoint(code) {
  const observer = document.getElementById('observer').value;
  const pointID = document.getElementById('pointID').value;
  const latlng = currentLatLng;
  const index = speciesMarkers.length;
  const count = 1;

  const marker = L.circleMarker(latlng, {
    radius: 10,
    color: 'blue',
    fillColor: 'white',
    fillOpacity: 1,
    weight: 2
  }).addTo(map);

  const dist = latlng.distanceTo(observerLocation);
  const angle = (Math.atan2(
    Math.sin((latlng.lng - observerLocation.lng) * Math.PI / 180) *
    Math.cos(latlng.lat * Math.PI / 180),
    Math.cos(observerLocation.lat * Math.PI / 180) *
    Math.sin(latlng.lat * Math.PI / 180) -
    Math.sin(observerLocation.lat * Math.PI / 180) *
    Math.cos(latlng.lat * Math.PI / 180) *
    Math.cos((latlng.lng - observerLocation.lng) * Math.PI / 180)
  ) * 180 / Math.PI + 360) % 360;

  const label = L.marker([latlng.lat, latlng.lng + 0.0001], {
    icon: L.divIcon({
      className: 'marker-label',
      html: `${code} (${count})`,
      iconAnchor: [0, 10]
    })
  }).addTo(map);

  const timestamp = new Date().toLocaleString();

  const popup = document.createElement('div');
  popup.className = 'popup-content';
  popup.innerHTML = `
    <b>${code}</b><br>
    Count: <span id="count-${index}">${count}</span><br>
    <button onclick="incrementCount(${index})">+</button>
    <button onclick="decrementCount(${index})">âˆ’</button><br>
    <button onclick="updateCount(${index})">Update</button>
    <button onclick="deleteMarker(${index})">Delete</button>
  `;
  marker.bindPopup(popup);

  speciesMarkers.push({ marker, label, code, count, observer, pointID, range: Math.round(dist), bearing: Math.round(angle), timestamp });
  updateTable();
  closeModal();
}

function updateCount(index) {
  const span = document.getElementById(`count-${index}`);
  if (span && speciesMarkers[index]) {
    speciesMarkers[index].count = parseInt(span.textContent);
    speciesMarkers[index].label.setIcon(L.divIcon({
      className: 'marker-label',
      html: `${speciesMarkers[index].code} (${span.textContent})`,
      iconAnchor: [0, 10]
    }));
    updateTable();
  }
}

function incrementCount(index) {
  const span = document.getElementById(`count-${index}`);
  if (span) span.textContent = parseInt(span.textContent) + 1;
}

function decrementCount(index) {
  const span = document.getElementById(`count-${index}`);
  if (span) span.textContent = Math.max(0, parseInt(span.textContent) - 1);
}

function deleteMarker(index) {
  const m = speciesMarkers[index];
  if (m) {
    map.removeLayer(m.marker);
    map.removeLayer(m.label);
    speciesMarkers[index] = null;
    updateTable();
  }
}

function updateTable() {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = '';
  speciesMarkers.forEach((m, i) => {
    if (!m) return;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${m.pointID}</td>
      <td>${m.observer}</td>
      <td>${m.code}</td>
      <td>${m.count}</td>
      <td>${m.range}</td>
      <td>${m.bearing}</td>
      <td>${m.timestamp}</td>
    `;
    tbody.appendChild(row);
  });
}

function openDrawer() {
  document.getElementById('dataDrawer').style.display = 'block';
  document.getElementById('modalBackdrop').style.display = 'block';
}

function closeDrawer() {
  document.getElementById('dataDrawer').style.display = 'none';
  document.getElementById('modalBackdrop').style.display = 'none';
}

function exportCSV() {
  let rows = [['POINT_ID', 'OBSERVER', 'SPECIES', 'SP_Count', 'RANGE', 'BEARING', 'OBS_TIMESTAMP']];
  speciesMarkers.forEach(m => {
    if (m) rows.push([m.pointID, m.observer, m.code, m.count, m.range, m.bearing, m.timestamp]);
  });
  const csv = rows.map(e => e.join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "species_data.csv";
  a.click();
}

function exportGeoJSON() {
  const features = speciesMarkers.filter(m => m).map(m => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: [m.marker.getLatLng().lng, m.marker.getLatLng().lat]
    },
    properties: {
      POINT_ID: m.pointID,
      OBSERVER: m.observer,
      SPECIES: m.code,
      SP_Count: m.count,
      RANGE: m.range,
      BEARING: m.bearing,
      OBS_TIMESTAMP: m.timestamp
    }
  }));
  const geojson = {
    type: "FeatureCollection",
    features
  };
  const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "species_data.geojson";
  a.click();
}

document.getElementById('speciesSearch').addEventListener('input', function () {
  updateSpeciesList(this.value);
});

map.on('click', e => {
  if (!placingPoint) showSpeciesModal(e.latlng);
});
</script>
</body>
</html>